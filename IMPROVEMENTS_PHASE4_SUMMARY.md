# –û—Ç—á–µ—Ç –æ —É–ª—É—á—à–µ–Ω–∏—è—Ö –§–∞–∑—ã 4: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è Retry –ª–æ–≥–∏–∫–∏ –∏ ThreadPoolExecutor

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è Retry –ª–æ–≥–∏–∫–∏ ‚≠ê‚≠ê‚≠ê

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å:** `bot_engine/utils/retry_utils.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `@retry_with_backoff` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- `@async_retry_with_backoff` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- `@retry_on_specific_errors` - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è retry —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:**
- ‚úÖ `bot_engine/storage.py` - —Ñ—É–Ω–∫—Ü–∏—è `save_json_file`
- ‚úÖ `bot_engine/async_storage.py` - —Ñ—É–Ω–∫—Ü–∏—è `_save_file_immediate`
- ‚úÖ `bots_modules/sync_and_cache.py` - —Ñ—É–Ω–∫—Ü–∏—è `sync_bots_with_exchange`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã retry (max_retries, backoff_multiplier, initial_delay)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫
- Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

### 2. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è ThreadPoolExecutor ‚≠ê‚≠ê‚≠ê

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å:** `bot_engine/utils/thread_pool_manager.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `ThreadPoolManager` - –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–ª–∞–º–∏ –ø–æ—Ç–æ–∫–æ–≤
- `get_io_executor()` - –ø—É–ª –¥–ª—è I/O –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3 –ø–æ—Ç–æ–∫–∞)
- `get_calculation_executor()` - –ø—É–ª –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20 –ø–æ—Ç–æ–∫–æ–≤)
- `get_api_executor()` - –ø—É–ª –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 –ø–æ—Ç–æ–∫–æ–≤)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:**
- ‚úÖ `bot_engine/async_storage.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_io_executor()`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–ª–∞–º–∏ –ø–æ—Ç–æ–∫–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –ï–¥–∏–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- –õ–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤

---

### 3. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ ‚≠ê‚≠ê

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å:** `bot_engine/utils/lock_utils.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `acquire_lock_with_timeout()` - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
- `acquire_rlock_with_timeout()` - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- `safe_lock_operation()` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤
- –£–¥–æ–±–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ deadlock'–æ–≤

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –°–æ–∑–¥–∞–Ω–æ –º–æ–¥—É–ª–µ–π:
- ‚úÖ `bot_engine/utils/retry_utils.py` - 3 –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
- ‚úÖ `bot_engine/utils/thread_pool_manager.py` - –º–µ–Ω–µ–¥–∂–µ—Ä –ø—É–ª–æ–≤ –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ `bot_engine/utils/lock_utils.py` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:
- ‚úÖ `bot_engine/storage.py` - –ø—Ä–∏–º–µ–Ω–µ–Ω retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
- ‚úÖ `bot_engine/async_storage.py` - –ø—Ä–∏–º–µ–Ω–µ–Ω—ã retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏ ThreadPoolManager
- ‚úÖ `bots_modules/sync_and_cache.py` - –ø—Ä–∏–º–µ–Ω–µ–Ω retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

### –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –≤ 3 –º–µ—Å—Ç–∞—Ö
- ‚úÖ ThreadPoolExecutor —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ async_storage.py

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–ª—É—á—à–µ–Ω–∏—è –∫–æ–¥–∞:
1. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ:** Retry –ª–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è:** ThreadPoolExecutor —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
- –õ—É—á—à–µ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –ú–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤:

```python
from bot_engine.utils.retry_utils import retry_with_backoff

@retry_with_backoff(max_retries=3, initial_delay=0.1)
def save_data():
    # –í–∞—à –∫–æ–¥
    pass
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ThreadPoolManager:

```python
from bot_engine.utils.thread_pool_manager import get_calculation_executor

executor = get_calculation_executor()
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ executor –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ lock —É—Ç–∏–ª–∏—Ç:

```python
from bot_engine.utils.lock_utils import acquire_lock_with_timeout

with acquire_lock_with_timeout(my_lock, timeout=5.0) as acquired:
    if acquired:
        # –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
        pass
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å ThreadPoolManager –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö (filters.py, continuous_data_loader.py)
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å lock —É—Ç–∏–ª–∏—Ç—ã –≤ –º–µ—Å—Ç–∞—Ö —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏
3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π –∫–æ–¥–∞

---

**–î–∞—Ç–∞:** 2025-11-08  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –§–ê–ó–ê 4 –ó–ê–í–ï–†–®–ï–ù–ê

