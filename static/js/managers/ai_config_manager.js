/**
 * AI Config Manager - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ AI –º–æ–¥—É–ª–µ–π
 */

class AIConfigManager {
    constructor() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è URL —á—Ç–æ –∏ –≤ bots_manager.js
        this.BOTS_SERVICE_URL = `${window.location.protocol}//${window.location.hostname}:5001`;
        this.aiConfig = null;
        this.licenseInfo = null;
        
        console.log('[AIConfigManager] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        console.log('[AIConfigManager] BOTS_SERVICE_URL:', this.BOTS_SERVICE_URL);
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
     */
    async initialize() {
        try {
            console.log('[AIConfigManager] –ó–∞–≥—Ä—É–∑–∫–∞ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é
            await this.loadAIConfig();
            
            // –ï—Å–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è –≤–∞–ª–∏–¥–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ AI
            console.log('[AIConfigManager] üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏:', this.licenseInfo);
            if (this.licenseInfo && this.licenseInfo.valid) {
                console.log('[AIConfigManager] ‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –≤–∞–ª–∏–¥–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º AI –±–ª–æ–∫');
                this.showAIConfigSection();
                this.bindEvents();
            } else {
                console.log('[AIConfigManager] ‚ùå AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)');
                this.hideAIConfigSection();
            }
        } catch (error) {
            console.error('[AIConfigManager] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            this.hideAIConfigSection();
        }
    }
    
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    async loadAIConfig() {
        try {
            const response = await fetch(`${this.BOTS_SERVICE_URL}/api/ai/config`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.aiConfig = data.config;
                this.licenseInfo = data.license;
                
                console.log('[AIConfigManager] ‚úÖ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                console.log('[AIConfigManager] –õ–∏—Ü–µ–Ω–∑–∏—è:', this.licenseInfo);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                this.populateForm();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º badge –ª–∏—Ü–µ–Ω–∑–∏–∏
                this.updateLicenseBadge();
            } else {
                console.error('[AIConfigManager] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', data.error);
            }
        } catch (error) {
            console.error('[AIConfigManager] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
            throw error;
        }
    }
    
    /**
     * –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    populateForm() {
        if (!this.aiConfig) return;
        
        const config = this.aiConfig;
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        this.setCheckbox('aiEnabled', config.ai_enabled);
        
        // Anomaly Detection
        this.setCheckbox('anomalyDetectionEnabled', config.anomaly_detection_enabled);
        this.setValue('anomalyBlockThreshold', config.anomaly_block_threshold);
        this.setCheckbox('anomalyLogEnabled', config.anomaly_log_enabled);
        
        // LSTM Predictor
        this.setCheckbox('lstmEnabled', config.lstm_enabled);
        this.setValue('lstmMinConfidence', config.lstm_min_confidence);
        this.setValue('lstmWeight', config.lstm_weight);
        
        // Pattern Recognition
        this.setCheckbox('patternEnabled', config.pattern_enabled);
        this.setValue('patternMinConfidence', config.pattern_min_confidence);
        this.setValue('patternWeight', config.pattern_weight);
        
        // Risk Management
        this.setCheckbox('riskManagementEnabled', config.risk_management_enabled);
        this.setValue('riskUpdateInterval', config.risk_update_interval);
        
        // Optimal Entry Detection
        this.setCheckbox('optimalEntryEnabled', config.optimal_entry_enabled);

        // –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ AI
        this.setCheckbox('selfLearningEnabled', config.self_learning_enabled);
        
        // Auto Training
        this.setCheckbox('autoTrainEnabled', config.auto_train_enabled);
        this.setCheckbox('autoUpdateData', config.auto_update_data);
        this.setValue('dataUpdateInterval', config.data_update_interval);
        this.setCheckbox('autoRetrain', config.auto_retrain);
        this.setValue('retrainInterval', config.retrain_interval);
        this.setValue('retrainHour', config.retrain_hour);
        
        // Logging
        this.setCheckbox('logPredictions', config.log_predictions);
        this.setCheckbox('logAnomalies', config.log_anomalies);
        this.setCheckbox('logPatterns', config.log_patterns);
        
        console.log('[AIConfigManager] ‚úÖ –§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
    }
    
    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    async saveAIConfig() {
        try {
            console.log('[AIConfigManager] üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const configData = {
                // –û—Å–Ω–æ–≤–Ω—ã–µ
                ai_enabled: this.getCheckbox('aiEnabled'),
                
                // Anomaly Detection
                anomaly_detection_enabled: this.getCheckbox('anomalyDetectionEnabled'),
                anomaly_block_threshold: parseFloat(this.getValue('anomalyBlockThreshold')),
                anomaly_log_enabled: this.getCheckbox('anomalyLogEnabled'),
                
                // LSTM Predictor
                lstm_enabled: this.getCheckbox('lstmEnabled'),
                lstm_min_confidence: parseFloat(this.getValue('lstmMinConfidence')),
                lstm_weight: parseFloat(this.getValue('lstmWeight')),
                
                // Pattern Recognition
                pattern_enabled: this.getCheckbox('patternEnabled'),
                pattern_min_confidence: parseFloat(this.getValue('patternMinConfidence')),
                pattern_weight: parseFloat(this.getValue('patternWeight')),
                
                // Risk Management
                risk_management_enabled: this.getCheckbox('riskManagementEnabled'),
                risk_update_interval: parseInt(this.getValue('riskUpdateInterval')),
                
                // Optimal Entry Detection
                optimal_entry_enabled: this.getCheckbox('optimalEntryEnabled'),

                // –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ AI
                self_learning_enabled: this.getCheckbox('selfLearningEnabled'),
                
                // Auto Training
                auto_train_enabled: this.getCheckbox('autoTrainEnabled'),
                auto_update_data: this.getCheckbox('autoUpdateData'),
                data_update_interval: parseInt(this.getValue('dataUpdateInterval')),
                auto_retrain: this.getCheckbox('autoRetrain'),
                retrain_interval: parseInt(this.getValue('retrainInterval')),
                retrain_hour: parseInt(this.getValue('retrainHour')),
                
                // Logging
                log_predictions: this.getCheckbox('logPredictions'),
                log_anomalies: this.getCheckbox('logAnomalies'),
                log_patterns: this.getCheckbox('logPatterns')
            };
            
            console.log('[AIConfigManager] –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', configData);
            
            const response = await fetch(`${this.BOTS_SERVICE_URL}/api/ai/config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                console.log('[AIConfigManager] ‚úÖ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (window.showToast) {
                    window.showToast('‚úÖ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                await this.loadAIConfig();
                
                return true;
            } else {
                console.error('[AIConfigManager] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data.error);
                
                if (window.showToast) {
                    window.showToast(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
                
                return false;
            }
        } catch (error) {
            console.error('[AIConfigManager] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
            
            if (window.showToast) {
                window.showToast(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
            
            return false;
        }
    }
    
    /**
     * –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    showAIConfigSection() {
        const section = document.getElementById('aiConfigSection');
        if (section) {
            section.style.display = 'block';
            console.log('[AIConfigManager] ‚úÖ AI –±–ª–æ–∫ –ø–æ–∫–∞–∑–∞–Ω');

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è
            this.loadSelfLearningOnShow();
        }
    }
    
    /**
     * –°–∫—Ä—ã—Ç—å –±–ª–æ–∫ AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    hideAIConfigSection() {
        const section = document.getElementById('aiConfigSection');
        if (section) {
            section.style.display = 'none';
            console.log('[AIConfigManager] ‚ÑπÔ∏è AI –±–ª–æ–∫ —Å–∫—Ä—ã—Ç (–Ω–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏)');
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ badge –ª–∏—Ü–µ–Ω–∑–∏–∏
     */
    updateLicenseBadge() {
        const badge = document.getElementById('aiLicenseBadge');
        if (!badge || !this.licenseInfo) return;
        
        const isValid = this.licenseInfo.valid;
        const licenseType = this.licenseInfo.type;
        const expiresAt = this.licenseInfo.expires_at;
        
        if (isValid) {
            badge.innerHTML = `
                <span class="badge badge-success">
                    ‚úÖ <span data-translate="license_active">–õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–Ω–∞</span>: ${licenseType}
                    ${expiresAt !== '9999-12-31' ? ` (–¥–æ ${expiresAt})` : ''}
                </span>
            `;
        } else {
            badge.innerHTML = `
                <span class="badge badge-danger">
                    ‚ùå <span data-translate="license_invalid">–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞</span>
                </span>
            `;
        }
    }
    
    /**
     * –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
     */
    bindEvents() {
        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è AI –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const saveBtn = document.querySelector('.config-section-save-btn[data-section="ai"]');
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                await this.saveAIConfig();
            });
            console.log('[AIConfigManager] ‚úÖ –°–æ–±—ã—Ç–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã');
        }

        // –°–æ–±—ã—Ç–∏—è –¥–ª—è —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è AI
        this.bindSelfLearningEvents();
    }

    /**
     * –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è AI
     */
    bindSelfLearningEvents() {
        const refreshBtn = document.getElementById('refreshSelfLearningBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.loadSelfLearningResults();
            });
            console.log('[AIConfigManager] ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã');
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è AI
     */
    async loadSelfLearningResults() {
        try {
            console.log('[AIConfigManager] üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è...');

            const resultsContent = document.getElementById('selfLearningResultsContent');
            if (!resultsContent) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            resultsContent.innerHTML = `
                <div class="loading-results">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <span>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</span>
                </div>
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const statsResponse = await fetch(`${this.BOTS_SERVICE_URL}/api/ai/self-learning/stats`);
            const statsData = await statsResponse.json();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const perfResponse = await fetch(`${this.BOTS_SERVICE_URL}/api/ai/self-learning/performance`);
            const perfData = await perfResponse.json();

            if (statsData.success && perfData.success) {
                this.displaySelfLearningResults(statsData.stats, perfData.performance, perfData.trends);
                console.log('[AIConfigManager] ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } else {
                const errorMsg = statsData.error || perfData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                this.displaySelfLearningError(errorMsg);
            }

        } catch (error) {
            console.error('[AIConfigManager] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è:', error);
            this.displaySelfLearningError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è
     */
    displaySelfLearningResults(stats, performance, trends) {
        const resultsContent = document.getElementById('selfLearningResultsContent');
        if (!resultsContent) return;

        const statsData = stats.stats || {};

        let html = '';

        // –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (performance && !performance.error) {
            html += `
                <div class="self-learning-metrics">
                    <div class="metric-card">
                        <h6>Win Rate AI</h6>
                        <div class="metric-value ${performance.ai_win_rate > 0.6 ? 'positive' : performance.ai_win_rate > 0.5 ? '' : 'negative'}">
                            ${(performance.ai_win_rate * 100).toFixed(1)}%
                        </div>
                        ${performance.non_ai_win_rate ? `
                            <div class="metric-trend ${performance.win_rate_difference > 0 ? 'positive' : 'negative'}">
                                vs ${(performance.non_ai_win_rate * 100).toFixed(1)}% (–±–µ–∑ AI)
                            </div>
                        ` : ''}
                    </div>

                    <div class="metric-card">
                        <h6>Avg PnL AI</h6>
                        <div class="metric-value ${performance.ai_avg_pnl > 0 ? 'positive' : 'negative'}">
                            $${performance.ai_avg_pnl.toFixed(2)}
                        </div>
                        ${performance.non_ai_avg_pnl ? `
                            <div class="metric-trend ${performance.avg_pnl_difference > 0 ? 'positive' : 'negative'}">
                                vs $${performance.non_ai_avg_pnl.toFixed(2)} (–±–µ–∑ AI)
                            </div>
                        ` : ''}
                    </div>

                    <div class="metric-card">
                        <h6>–†–µ–π—Ç–∏–Ω–≥ AI</h6>
                        <div class="metric-value">
                            ${performance.ai_performance_score || 0}/3
                        </div>
                        <div class="metric-trend">
                            ${performance.ai_performance_rating || '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ'}
                        </div>
                    </div>

                    <div class="metric-card">
                        <h6>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–¥–µ–ª–æ–∫</h6>
                        <div class="metric-value">
                            ${statsData.total_trades_processed || 0}
                        </div>
                        <div class="metric-trend">
                            –û–Ω–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${statsData.online_updates || 0}
                        </div>
                    </div>
                </div>
            `;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è
        html += `
            <div class="self-learning-stats">
                <h6>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—è</h6>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">–û–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏–µ:</span>
                        <span class="stat-value">${stats.online_learning_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω–æ' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω–æ'}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ä—ã–Ω–∫—É:</span>
                        <span class="stat-value">${stats.adaptive_learning_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω–æ' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω–æ'}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö –∞–¥–∞–ø—Ç–∞—Ü–∏–π:</span>
                        <span class="stat-value">${statsData.successful_adaptations || 0}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞:</span>
                        <span class="stat-value">${stats.buffer_size || 0} —Å–¥–µ–ª–æ–∫</span>
                    </div>
                </div>
            </div>
        `;

        // –¢—Ä–µ–Ω–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (trends && !trends.error) {
            html += `
                <div class="performance-trends">
                    <h6>üìä –¢—Ä–µ–Ω–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h6>
                    <div class="trend-info">
                        <div class="trend-item">
                            <span class="trend-label">–¢—Ä–µ–Ω–¥ Win Rate:</span>
                            <span class="trend-value ${trends.win_rate_trend > 0 ? 'positive' : trends.win_rate_trend < 0 ? 'negative' : ''}">
                                ${trends.win_rate_trend > 0 ? '‚ÜóÔ∏è –†–∞—Å—Ç–µ—Ç' : trends.win_rate_trend < 0 ? '‚ÜòÔ∏è –ü–∞–¥–∞–µ—Ç' : '‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω—ã–π'}
                            </span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">–¢—Ä–µ–Ω–¥ Avg PnL:</span>
                            <span class="trend-value ${trends.avg_pnl_trend > 0 ? 'positive' : trends.avg_pnl_trend < 0 ? 'negative' : ''}">
                                ${trends.avg_pnl_trend > 0 ? '‚ÜóÔ∏è –†–∞—Å—Ç–µ—Ç' : trends.avg_pnl_trend < 0 ? '‚ÜòÔ∏è –ü–∞–¥–∞–µ—Ç' : '‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω—ã–π'}
                            </span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">–û–±—â–∏–π —Ç—Ä–µ–Ω–¥:</span>
                            <span class="trend-value ${trends.ai_improving ? 'positive' : 'negative'}">
                                ${trends.ai_improving ? 'üöÄ AI —É–ª—É—á—à–∞–µ—Ç—Å—è' : '‚ö†Ô∏è AI —Å—Ç–∞–±–∏–ª—å–µ–Ω –∏–ª–∏ —É—Ö—É–¥—à–∞–µ—Ç—Å—è'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        if (performance && performance.error) {
            html += `
                <div class="no-results">
                    <div class="no-results-icon">üìä</div>
                    <p>${performance.error}</p>
                    <small>–ù–∞–∫–æ–ø–∏—Ç–µ –±–æ–ª—å—à–µ —Å–¥–µ–ª–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ AI</small>
                </div>
            `;
        }

        resultsContent.innerHTML = html;
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    displaySelfLearningError(errorMsg) {
        const resultsContent = document.getElementById('selfLearningResultsContent');
        if (!resultsContent) return;

        resultsContent.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">‚ö†Ô∏è</div>
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                <small>${errorMsg}</small>
            </div>
        `;
    }

    /**
     * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ AI —Å–µ–∫—Ü–∏–∏
     */
    loadSelfLearningOnShow() {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏ AI
        setTimeout(() => {
            this.loadSelfLearningResults();
        }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
    }
    
    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ä–º–æ–π
    setCheckbox(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.checked = Boolean(value);
        }
    }
    
    getCheckbox(id) {
        const element = document.getElementById(id);
        return element ? element.checked : false;
    }
    
    setValue(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.value = value;
        }
    }
    
    getValue(id) {
        const element = document.getElementById(id);
        return element ? element.value : null;
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.aiConfigManager = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async () => {
    try {
        window.aiConfigManager = new AIConfigManager();
        await window.aiConfigManager.initialize();
    } catch (error) {
        console.error('[AIConfigManager] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    }
});

