# Режим полного ИИ-управления сделками (bots.py)

**Версия:** 0.3 (вариант B; отдельный конфиг и таблица ПРИИ; при выключении ПРИИ — возврат к обычному режиму без изменений пользовательского конфига)  
**Дата:** 17.02.2026

---

## 1. Предварительное предложение

### 1.1 Цель

Добавить в bots.py **переключаемый через UI режим**, в котором:

- **Стандартный режим (как сейчас):** решение о входе/выходе принимает скрипт (RSI, тренд, фильтры) с опциональным подтверждением/блокировкой от ИИ (`ai_enabled` / `ai_override_original`).
- **Режим полного ИИ (вариант B):** решение о **входе и о выходе («закрыть сейчас»)** принимает ИИ. Скрипт исполняет ордера и соблюдает только те ограничения, которые заданы пользователем. ИИ **полностью отталкивается от параметров, заложенных в конфиге как возможные**, и может менять их как хочет (по монетам, в БД), кроме одного исключения: **таймфрейм задаётся только пользователем в конфиге и ИИ никогда его не меняет**.

### 1.2 Ключевые принципы

| Принцип | Описание |
|--------|----------|
| Один переключатель в UI | Одна настройка «Режим полного ИИ» (вкл/выкл), без дублирования в нескольких экранах. Реализовано на вкладке **Управление** рядом с тумблером Auto Bot. |
| **Таймфрейм только пользователь** | **Таймфрейм задаётся только в конфиге пользователем и никогда не изменяется ИИ.** Все расчёты, свечи, RSI и т.д. ведутся на этом таймфрейме. ИИ не имеет доступа к смене таймфрейма. |
| **Отдельный конфиг и таблица ПРИИ** | Для режима ПРИИ используются **отдельный конфиг** (который ИИ может менять как хочет в рамках пространства, заданного пользователем) и **отдельная таблица в БД** для параметров по монетам в ПРИИ. Обычный конфиг пользователя и `individual_coin_settings` **не затрагиваются**. При выключении ПРИИ бот сразу возвращается к обычному режиму: используются только пользовательский конфиг и обычные настройки монет — ничего возвращать не нужно, т.к. они не перезаписывались. |
| Конфиг — пространство возможных параметров | В **пользовательском** конфиге задаются возможные параметры (диапазоны, опции). ИИ в ПРИИ меняет только **копию/отдельный конфиг ПРИИ** и данные в **таблице ПРИИ** по монетам. Единственное жёсткое исключение — таймфрейм (всегда из пользовательского конфига). |
| Параметры на монету в БД (ПРИИ) | ИИ пишет и обновляет настройки по каждой монете в **отдельной таблице ПРИИ** (например `full_ai_coin_params` или `prii_coin_params`); при включённом ПРИИ используются только она и конфиг ПРИИ. Таблица `individual_coin_settings` для обычного режима не используется и не изменяется в ПРИИ. |
| Обучение на результатах | ИИ дообучается и обновляет параметры на основе исходов сделок (PnL, TP/SL, изучение совершённых сделок). |
| Изучение совершённых сделок | Бот **обязательно** анализирует уже совершённые сделки (из БД и с биржи), оценивает правильность/неправильность решений и дорабатывает стратегию (параметры по монетам, при необходимости — модели). |

### 1.3 Выбранный уровень: вариант B (ИИ управляет и входом, и выходом)

**Вариант B — основной сценарий реализации:**

- **Вход:** сигнал ENTER_LONG / ENTER_SHORT / WAIT выдаёт ИИ (LSTM, паттерны, аномалии, SMC и т.д.).
- **Выход:** решение «держать или закрыть сейчас» тоже принимает ИИ (отдельный вызов `get_ai_exit_decision`). Скрипт не навязывает RSI/trailing/break_even как обязательную логику — при полном ИИ решение о закрытии принимает только ИИ.
- **Параметры:** ИИ меняет только **отдельный конфиг ПРИИ** и данные в **отдельной таблице ПРИИ** по монетам. Пользовательский конфиг и `individual_coin_settings` не трогаются. Таймфрейм всегда берётся только из пользовательского конфига.
- Скрипт исполняет ордера; при ПРИИ читает/пишет только конфиг ПРИИ и таблицу ПРИИ.

### 1.4 Ограничения и риски

- **Таймфрейм:** единственный параметр, который ИИ не меняет ни при каких условиях. Задаётся только пользователем в конфиге (как сейчас).  
- **Лицензия ИИ:** в режиме полного ИИ все решения зависят от ИИ; при невалидной лицензии режим должен быть недоступен или принудительно отключён.  
- **Холодный старт:** для новых монет нет истории сделок — нужны дефолтные параметры из конфига или копирование с «похожей» монеты.  
- **Консистентность:** переключение режима (ПРИИ ↔ стандарт) не должно ломать уже открытые позиции; выход по уже открытым может идти по старым правилам до закрытия.
- **При выключении ПРИИ:** все настройки, которые были до включения ПРИИ, остаются в силе — пользовательский конфиг и `individual_coin_settings` не менялись. Используются снова только они; конфиг ПРИИ и таблица ПРИИ просто перестают использоваться. Возврат к обычному режиму автоматический, без шага «восстановить конфиг».

---

## 2. Техническое задание (для оценки)

### 2.1 Настройка и хранение

| № | Задача | Детали |
|---|--------|--------|
| 2.1.1 | Добавить флаг в конфиг | Новый ключ в `auto_bot_config`: например `full_ai_control: bool` (по умолчанию `False`). Сохранять через существующий механизм (POST `/api/bots/auto-bot`), писать в `bot_config.py` и/или в БД (как остальные ключи auto_bot). |
| 2.1.2 | UI: переключатель | В разделе настроек ботов (например, рядом с «AI подтверждение» / «AI блокирует скрипт») добавить один переключатель «Режим полного ИИ» (или «ИИ управляет входами/выходами»). Привязать к `full_ai_control` через `mapElementIdToConfigKey` и `collectConfigurationData`; сохранение — тем же блоком, что и «Основные настройки» (saveBasicSettings или отдельная кнопка). |
| 2.1.3 | Условие доступности | Переключатель активен только если `ai_enabled === true` и лицензия ИИ валидна (можно дергать GET `/api/ai/status` или аналог). Иначе — disabled + подсказка «Включите ИИ и проверьте лицензию». |

### 2.2 Отдельный конфиг ПРИИ и отдельная таблица в БД (обычный режим не затрагивается)

| № | Задача | Детали |
|---|--------|--------|
| 2.2.1 | Отдельный конфиг ПРИИ | Хранить **отдельный конфиг для ПРИИ** (например в БД или в отдельном файле `configs/full_ai_config.json` / ключ в bots_data). При включении ПРИИ он инициализируется копией пользовательского конфига (или пространства параметров из него); далее ИИ меняет только этот конфиг. Пользовательский `auto_bot_config` / `bot_config.py` **не перезаписываются**. Таймфрейм в конфиг ПРИИ не копируется как изменяемый — всегда читается из пользовательского конфига. |
| 2.2.2 | Отдельная таблица ПРИИ по монетам | **Отдельная таблица в БД** только для ПРИИ, например `full_ai_coin_params` или `prii_coin_params` (symbol, params_json или нормализованные поля, updated_at, created_at). Используется **только** при `full_ai_control === true`. Таблица `individual_coin_settings` для обычного режима не читается и не записывается в ПРИИ. Так обычный режим не затрагивается. |
| 2.2.3 | Миграция и API | Миграция в `bots_database.py` на создание таблицы ПРИИ при отсутствии. Методы: `save_full_ai_coin_params(symbol, params)`, `load_full_ai_coin_params(symbol)`, `load_all_full_ai_coin_params()`. При необходимости — эндпоинты GET/POST для одной монеты и списка (по аналогии с individual-settings), с проверкой что данные относятся к ПРИИ. |
| 2.2.4 | При выключении ПРИИ | При переключении `full_ai_control` в `false`: в рантайме перестать использовать конфиг ПРИИ и таблицу ПРИИ; использовать только пользовательский конфиг и `individual_coin_settings`. Никакого шага «вернуть конфиг» не требуется — пользовательский конфиг не менялся. Конфиг ПРИИ и таблица ПРИИ остаются в БД/файле для следующего включения ПРИИ. |

### 2.3 Логика принятия решений (вход)

| № | Задача | Детали |
|---|--------|--------|
| 2.3.1 | Ветка «полный ИИ» при входе | В `bot_class.py` в `should_open_long` / `should_open_short`: если `auto_bot_config.get('full_ai_control')` и ИИ доступен — **не** вызывать классические проверки RSI/тренд/время; вместо этого вызвать единый метод ИИ (например `ai_integration.get_ai_entry_decision(symbol, direction, candles, config)`), который возвращает `{ allowed: bool, confidence?, reason? }`. При `allowed=True` — считать вход разрешённым; при `False` — отказ. |
| 2.3.2 | Источник параметров при ПРИИ | Для полного ИИ использовать только **конфиг ПРИИ** и **таблицу ПРИИ** (full_ai_coin_params) для данной монеты; если записи по монете нет — fallback на конфиг ПРИИ или дефолты из пространства параметров пользователя. Пользовательский конфиг и individual_coin_settings не читать в ветке ПРИИ. |
| 2.3.3 | Фильтры и лимиты | Делистинг и прочие нефункциональные проверки сохраняются. Лимиты задаются пользовательским конфигом как пространство; ИИ выбирает значения в рамках конфига ПРИИ и таблицы ПРИИ. Таймфрейм **всегда** только из пользовательского конфига. |

### 2.4 Логика выхода (вариант B: ИИ решает «закрыть сейчас»)

| № | Задача | Детали |
|---|--------|--------|
| 2.4.1 | ИИ решает о закрытии позиции | В режиме ПРИИ при каждой проверке выхода вызывать ИИ: `get_ai_exit_decision(symbol, position, candles, pnl_percent, prii_config, full_ai_coin_params)` → `{ close_now: bool, reason?, confidence? }`. Если `close_now === true` — закрывать позицию. Классическая логика выхода по RSI/trailing/break_even не используется; решение принимает только ИИ. Параметры по монете — из таблицы ПРИИ. |
| 2.4.2 | Параметры выхода от ИИ | ИИ хранит в **таблице ПРИИ** (full_ai_coin_params) любые нужные ему параметры выхода в пределах пространства, заданного пользовательским конфигом. Таймфрейм в таблице ПРИИ не хранится — используется только таймфрейм из пользовательского конфига. |

### 2.5 Изучение совершённых сделок и доработка стратегии (обязательно)

Бот должен **постоянно изучать уже совершённые сделки**, оценивать правильность/неправильность решений и **дорабатывать стратегию** (параметры по монетам, при необходимости — модели). Это ключевое требование режима полного ИИ.

| № | Задача | Детали |
|---|--------|--------|
| 2.5.1 | Источники данных по сделкам | **БД:** `bots_data.db` → таблица `bot_trades_history` (в неё загружаются и сохраняются все сделки ботов при закрытии; при необходимости можно подтягивать историю с биржи скриптом `rebuild_bot_history_from_exchange.py`). **Дополнительно:** `ai_data.db` → `get_trades_for_training()` для обогащения данных. Сделки с биржи (closed PnL) также могут использоваться для сверки и полноты. Итог: единый контур «все совершённые сделки доступны в БД», оттуда их читает модуль обучения. |
| 2.5.2 | Оценка правильности решений | По каждой закрытой сделке определять: **результат** (прибыль/убыток, PnL %, причина выхода: TP / SL / trailing / RSI exit / по времени и т.д.). Критерии «правильно/неправильно»: например, выход в плюс или по TP — хорошее решение; выход по SL или большой минус при раннем выходе — плохое; можно ввести градации (нейтрально/успех/неудача). При наличии `ai_decision_id` или метки источника (AI/SCRIPT) — отдельно оценивать решения, принятые ИИ. |
| 2.5.3 | Выводы и доработка стратегии | На основе оценок по сделкам: (1) **по символу** — корректировать параметры входа/выхода и сохранять **только в таблице ПРИИ** (full_ai_coin_params) и/или в конфиге ПРИИ; (2) при необходимости — формировать выборки для переобучения моделей в ai.py. Логировать выводы. Пользовательский конфиг и individual_coin_settings не изменять. |
| 2.5.4 | Когда запускать анализ | **Вариант A:** после каждой закрытой сделки (онлайн-обновление в bots.py). **Вариант B:** периодически по расписанию (раз в N минут/часов) батчем по последним закрытым сделкам. **Вариант C:** комбинация: лёгкий онлайн-апдейт после сделки + тяжёлый пересчёт параметров/моделей по расписанию (в bots.py или ai.py). Рекомендация: минимум — батч по расписанию в bots.py при включённом full_ai_control; при наличии ресурсов — плюс реакция на каждое закрытие. |

### 2.6 Обучение и запись ИИ-настроек в БД

| № | Задача | Детали |
|---|--------|--------|
| 2.6.1 | Кто пишет в конфиг ПРИИ и таблицу ПРИИ | Оптимизатор и/или модуль изучения сделок записывают параметры **только в конфиг ПРИИ** и в **таблицу ПРИИ** (full_ai_coin_params). Пользовательский конфиг и `individual_coin_settings` не трогаются. |
| 2.6.2 | Использование истории сделок | Для обучения/оптимизации и для модуля изучения сделок брать данные из `bot_trades_history` (bots_data.db); при необходимости — из ai_data.db и с биржи. Результаты обучения писать только в конфиг ПРИИ и таблицу ПРИИ. |
| 2.6.3 | Пространство параметров и таймфрейм | Диапазоны и опции задаются в **пользовательском** конфиге. ИИ меняет только конфиг ПРИИ и таблицу ПРИИ в рамках этого пространства. **Таймфрейм не входит в пространство изменяемых ИИ параметров:** задаётся только пользователем в конфиге и при записи в конфиг ПРИИ / таблицу ПРИИ не переопределяется. |

### 2.7 Контракты ИИ (вход и выход)

**Вход (псевдокод):**

- **Вход:** `symbol`, `direction` ('LONG'|'SHORT'), `candles`, `current_price`, `prii_config` (конфиг ПРИИ), per-coin из таблицы ПРИИ (full_ai_coin_params), опционально `coin_data`. **Таймфрейм** всегда из пользовательского конфига.
- **Выход:** `{ "allowed": bool, "confidence": float, "reason": str }`.  
- Внутри — использование существующих модулей: AIManager (LSTM, pattern, anomaly), SMC, ai_integration; порог по confidence из конфига (например `ai_min_confidence`). При полном ИИ этот вызов **заменяет** RSI/тренд проверки.

**Выход (вариант B, псевдокод):**

- **Вход:** `symbol`, `position`, `candles`, `pnl_percent`, `prii_config`, таблица ПРИИ для символа. Свечи и индикаторы — на **таймфрейме из пользовательского конфига**.
- **Выход:** `{ "close_now": bool, "reason": str, "confidence": float }`. При `close_now === true` скрипт закрывает позицию.

### 2.8 Безопасность и отображение в UI

| № | Задача | Детали |
|---|--------|--------|
| 2.8.1 | Явная индикация режима | В UI показывать текущий режим: «Стандартный» / «Полный ИИ» (например, рядом с переключателем или в шапке раздела ботов), чтобы пользователь не путал. |
| 2.8.2 | Логи | При каждом решении входа/выхода в режиме полного ИИ логировать, что решение принято ИИ (и при необходимости reason/confidence), для аудита и отладки. |
| 2.8.3 | Отключение при невалидной лицензии | При старте bots.py и при периодической проверке: если включён full_ai_control, но ИИ недоступен (лицензия не валидна) — принудительно сбросить full_ai_control в False и записать в конфиг; уведомить в логах и по возможности в UI (при следующем GET auto-bot). |
| 2.8.4 | Таймфрейм только из конфига | В коде и в UI ни при каких условиях не позволять ИИ или автоматике менять таймфрейм. Источник таймфрейма — только конфиг пользователя (как сейчас). |

---

## 3. Оценка объёма (ориентировочно)

| Блок | Оценка (часы) | Замечания |
|------|----------------|-----------|
| Конфиг + UI переключатель + доступность | 2–4 | Мало кода, проверка лицензии и сохранение |
| Отдельный конфиг ПРИИ + таблица ПРИИ в БД, миграция, API | 6–10 | Конфиг ПРИИ (файл/БД); таблица full_ai_coin_params; при выключении ПРИИ — только переключение источника, без восстановления |
| Логика входа: ветка full_ai_control + get_ai_entry_decision | 6–12 | Интеграция с filters/bot_class и ai_integration |
| Логика выхода: get_ai_exit_decision (вариант B) | 10–18 | ИИ решает «закрыть сейчас»; интеграция с циклом проверки позиций, без привязки к RSI/trailing как обязательным |
| ИИ меняет только конфиг ПРИИ и таблицу ПРИИ (кроме таймфрейма) | 4–8 | Чтение/запись конфига ПРИИ и full_ai_coin_params; таймфрейм только из пользовательского конфига |
| Изучение сделок + доработка стратегии (только ПРИИ-хранилище) | 12–20 | Обновление конфига ПРИИ и таблицы ПРИИ; пользовательский конфиг и individual_coin_settings не трогать |
| Обучение/запись в конфиг ПРИИ и таблицу ПРИИ | 8–16 | Оптимизатор и модуль изучения сделок пишут только в ПРИИ-хранилище |
| Логи, принудительное отключение, тесты | 4–6 | |
| **Итого (вариант B: вход + выход ИИ)** | **48–80** | С учётом изучения сделок и полного управления выходом |

---

## 4. Зависимости и порядок работ

1. Реализовать **отдельный конфиг ПРИИ** и **отдельную таблицу в БД** для ПРИИ (например `full_ai_coin_params`). Переключатель «Полный Режим ИИ» на вкладке Управление уже добавлен.  
2. При включении ПРИИ: использовать только конфиг ПРИИ и таблицу ПРИИ; при выключении — сразу переходить на пользовательский конфиг и `individual_coin_settings` (возврат без шага «восстановить»).  
3. Реализовать `get_ai_entry_decision` и ветку в `should_open_long`/`should_open_short` (источник параметров — конфиг ПРИИ и таблица ПРИИ).  
4. Реализовать `get_ai_exit_decision` и интеграцию в цикл проверки позиций: при full_ai_control решение о закрытии принимает только ИИ.  
5. Таймфрейм всегда только из пользовательского конфига; ИИ меняет только конфиг ПРИИ и таблицу ПРИИ.  
6. Модуль изучения сделок и оптимизатор пишут только в конфиг ПРИИ и таблицу ПРИИ.  
7. Обработка невалидной лицензии и индикация в UI.

**Зафиксировано:** вариант B; таймфрейм только пользователь; **отдельный конфиг ПРИИ + отдельная таблица ПРИИ** — обычный режим не затрагивается, при выключении ПРИИ все настройки «как до включения» (пользовательский конфиг не менялся).
