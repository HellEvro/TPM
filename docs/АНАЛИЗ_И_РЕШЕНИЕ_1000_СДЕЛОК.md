# Анализ 1000 сделок и пошаговое решение

**Дата анализа:** 2026-02-24  
**Источник:** `bot_trades_history` (bots_data.db), 1000 последних закрытых сделок

---

## 1. СОБРАННЫЕ ДАННЫЕ

| Метрика | Значение |
|---------|----------|
| Всего сделок | 1000 |
| С RSI (расчёт по свечам) | 322 |
| Без RSI (не удалось рассчитать) | 678 |
| Прибыльных (PnL > 0) | 58 |
| Убыточных (PnL < 0) | 49 |
| Безубыточных (PnL = 0) | 215 |
| **Win Rate (с RSI)** | **18.0%** |
| Суммарный PnL (сделки с RSI) | +0.44 USDT |
| Суммарный PnL (все 1000) | -2.63 USDT |

### Распределение входов по Entry RSI
- **LONG:** 122 при RSI 0–30 (перепроданность), 8 при 31–35 — входы по стратегии
- **SHORT:** 179 при RSI 66–100 (перекупленность), 2 при 51–65 — входы по стратегии

### Причины закрытия (сделки с RSI)
- **По RSI (по порогу):** 0
- **Закрыто на бирже/Sync (CLOSED_ON_EXCHANGE):** 322
- Stop Loss: 0
- Take Profit: 0

### Проблемные монеты (Win Rate 0%, мин. 3 сделки)
BOBBOB, FHE, EIGEN, EUL, NTRN, FOLKS, DIA, ARKM, AWE, ACX, GNO, 10000SATS, ZBT, VELODROME, OXT

---

## 2. АНАЛИЗ

### 2.1. Ключевая проблема: выходы не по RSI
**Все 322 сделки с RSI закрыты как CLOSED_ON_EXCHANGE.** Ни одна не закрылась по достижению RSI-порога. Это значит:
- Позиции исчезают с биржи до того, как RSI достигает порога выхода
- Возможные причины: ликвидация, принудительное закрытие, sync фиксирует исчезновение позиции
- Бот «ждал» RSI-выход, но позиция была сброшена внешним фактором

### 2.2. Низкий Win Rate (18%)
- 58 прибыльных vs 49 убыточных среди сделок с RSI — если считать только их: 58/(58+49) ≈ 54%
- 18% — это 58 из 322: 215 сделок закрылись с PnL = 0 (безубыток/ликвидация в ноль)
- Большинство сделок «зависают» в безубытке и закрываются внешним образом

### 2.3. 678 сделок без RSI
- Не хватает свечей в БД/ai_data для расчёта entry_rsi/exit_rsi
- При закрытии exit_rsi не сохраняется в sync_and_cache
- Для полноценного анализа нужен `--force-exchange` (загрузка свечей с биржи)

### 2.4. TP/SL в конфиге
- TAKE_PROFIT_PERCENT = 3%
- MAX_LOSS_PERCENT = 2%
- Соотношение TP:SL = 3:2 — приемлемо, но TP мал; много сделок «упираются» в безубыток

### 2.5. EXIT_WAIT_BREAKEVEN_WHEN_LOSS = False
- Сейчас отключено: бот не ждёт безубыток при убытке
- Раньше было True — могло приводить к долгому удержанию убыточных позиций

---

## 3. ВЫВОДЫ

1. **Позиции закрываются на бирже до достижения RSI-порога** — нужно выяснить, почему (ликвидация, маржин-колл, ручное закрытие, другой скрипт).
2. **Большинство сделок (678) без RSI** — нет полной картины для аналитики; нужно сохранять exit_rsi при закрытии и/или загружать свечи с биржи.
3. **Низкий Win Rate (18%)** — из‑за 215 безубыточных; прибыльных (58) больше, чем убыточных (49), но суммарный PnL минус из‑за сделок без RSI.
4. **Часть монет стабильно убыточна** — BOBBOB, FHE, EIGEN, EUL, NTRN и др. уже есть или должны быть в BLACKLIST.

---

## 4. РЕШЕНИЕ ПО ШАГАМ

### Шаг 1. Расширить BLACKLIST
**Файл:** `configs/bot_config.py`

Добавить в `AutoBotConfig.BLACKLIST` монеты из отчёта с Win Rate 0%:
```
EIGEN, EUL, NTRN, FOLKS, DIA, ARKM, AWE, GNO, 10000SATS, ZBT, VELODROME, OXT
```
*(ACX, BOBBOB, FHE уже в blacklist)*

### Шаг 2. Сохранять exit_rsi при закрытии
**Файл:** `bots_modules/sync_and_cache.py`

При закрытии позиции (CLOSED_ON_EXCHANGE) передавать в `save_bot_trade_history`:
- `exit_rsi` — из `coins_rsi_data` или `bot_data.last_rsi`
- `entry_timeframe` — таймфрейм бота

Проверить, что `sync_and_cache` при `record_real_close` / `history_log_position_closed` передаёт эти поля.

### Шаг 3. Периодически пересчитывать RSI и сохранять в БД
**Команда:**
```bash
python scripts/analyze_trades_rsi_exit.py --limit 5000 --force-exchange --save-to-db --output report.txt
```
Запускать раз в неделю или после массовой синхронизации — для заполнения entry_rsi/exit_rsi в старых сделках.

### Шаг 4. CLOSED_ON_EXCHANGE — что это значит
**Где:** `bots_modules/sync_and_cache.py` ~стр. 3341, 3472

`CLOSED_ON_EXCHANGE` = sync обнаружил, что позиция пропала с биржи (бот считал, что позиция ещё открыта). Sync пытается уточнить причину по exit_price:
- совпадение с TP (допуск 0.5%) → `BOT_LIMIT_TP`
- совпадение с SL → `BOT_LIMIT_SL`
- иначе → `MANUAL_OR_EXTERNAL` (ручное закрытие, ликвидация, внешний скрипт)

Если в отчёте «Закрыто на бирже/Sync» — в БД чаще всего хранится `CLOSED_ON_EXCHANGE`, т.е. точная причина не определена (проскальзывание, ликвидация и т.п.). TP=3%, SL=2% — узкий коридор; SL может срабатывать до достижения RSI-порога.

### Шаг 5. Смягчить пороги выхода по RSI (опционально)
**Файл:** `configs/bot_config.py`

Текущие пороги выхода уже смягчены (60/50 для LONG, 42/45 для SHORT). Если позиции по‑прежнему не доживают до RSI-выхода — рассмотреть:
- Снизить `RSI_EXIT_LONG_WITH_TREND` до 55–58
- Поднять `RSI_EXIT_SHORT_WITH_TREND` до 40–45
- Цель — чаще достигать выхода по RSI, а не по sync.

### Шаг 6. Увеличить TAKE_PROFIT_PERCENT (опционально)
**Файл:** `configs/bot_config.py`

Сейчас TP = 3%. При волатильности 5m может срабатывать слишком рано. Попробовать 5–6%, чтобы дать сделке шанс дойти до RSI-выхода.

### Шаг 7. Включить мониторинг
Добавить в cron/планировщик:
```bash
# Еженедельно: пересчёт RSI и отчёт
python scripts/analyze_trades_rsi_exit.py --limit 1000 --force-exchange --save-to-db --output data/reports/rsi_audit_$(date +%Y%m%d).txt
```

---

## 5. ПРИОРИТЕТ ДЕЙСТВИЙ (выполнено)

| # | Действие | Статус |
|---|----------|--------|
| 1 | Расширить BLACKLIST | ✅ Добавлены EIGEN, EUL, NTRN, FOLKS, DIA, ARKM, AWE, GNO, 10000SATS, ZBT, VELODROME, OXT, 1000000BABYDOGE, BMT, 1000CAT, AVA, ALPINE |
| 2 | Сохранение exit_rsi в sync | ✅ Добавлен вызов _refresh_rsi_for_bots_in_position в sync_bots_with_exchange перед обработкой закрытий |
| 3 | Пересчёт RSI с биржи | ✅ Запущено --force-exchange --save-to-db: 500 сделок с RSI, сохранено в БД |
| 4 | CLOSED_ON_EXCHANGE | ✅ Разъяснено в Шаге 4 |
| 5 | Смягчение RSI/TP | Опционально — при необходимости |

### Результат прогона --force-exchange --limit 500
- Все 500 сделок получили RSI (расчёт по свечам с биржи)
- Сохранено в БД: 500 записей
- 8 сделок с выходом по RSI в пороге; 492 — по другим причинам
