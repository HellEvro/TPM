# Разбор плохих результатов торговли

Краткий отчёт по возможным причинам множества убыточных сделок и что можно изменить.

---

## 1. Главные причины (по коду)

### Соотношение тейк-профит / стоп-лосс
- **Сейчас:** TP = 5%, SL = 15% (риск в 3 раза больше потенциальной прибыли).
- **Следствие:** Чтобы выходить в ноль, нужно ~75% прибыльных сделок. При типичной точности RSI-стратегий (50–60%) математика даёт минус.
- **Рекомендация:** Либо уменьшить SL (например 5–8%), либо увеличить TP (например 10–15%), чтобы соотношение было не хуже 1:1, лучше 1:1.5.

### Вход только по RSI
- Вход: LONG при RSI ≤ 29, SHORT при RSI ≥ 71.
- Плюс RSI time filter (минимум N свечей от экстремума) — часть входов отсекается или сдвигается.
- **Риск:** Входы на «откате после экстремума», когда тренд уже развернулся → частые мелкие минусы.

### Выход только по RSI
- Выход: LONG при RSI ≥ 65 (по тренду) или ≥ 60 (против), SHORT при RSI ≤ 35 / ≤ 40.
- Нет явной привязки к цели по цене/объёму.
- **Риск:** Ранний выход из прибыльных и долгое удержание убыточных позиций.

### Нет ограничения по суммарному риску
- Есть только лимит по числу ботов (`MAX_CONCURRENT = 50`).
- Нет проверки «суммарный риск ≤ X% депозита» и нет «макс. убыток за день».
- **Риск:** При серии минусов можно быстро набрать много убыточных позиций.

### Нет фильтра по ликвидности
- Торгуются все пары (scope=all, пустые whitelist/blacklist).
- В коде явно отключена проверка минимальной волатильности.
- **Риск:** Плохое исполнение и резкие минусы на низколиквидных парах.

### Режим «ждать безубыток»
- При включённом `exit_wait_breakeven_when_loss` при достижении RSI-зоны выхода в минусе позиция не закрывается, ждётся выход в плюс (≥ 0.05%).
- **Риск:** Долгое удержание убыточной позиции и рост просадки.

---

## 2. Где что лежит в коде

| Что | Файл |
|-----|------|
| Вход по RSI, создание ботов | `bots_modules/filters.py` (get_effective_signal, create_new_bot, enter_position) |
| Выход по RSI | `bots_modules/workers.py`, `bots_modules/bot_class.py` (check_should_close_by_rsi, check_exit_with_breakeven_wait) |
| Стоп/тейк/трейлинг | `bots_modules/sync_and_cache.py` (_select_stop_loss_price, _select_take_profit_price), `bot_engine/protections.py` |
| Конфиг автобота | `configs/bot_config.py` (или example) |
| Лимит позиций | `filters.py` — слоты = max_concurrent - текущие активные боты |

---

## 3. Что сделать в первую очередь

### 3.1. Настройки в `configs/bot_config.py`
- Уменьшить **MAX_LOSS_PERCENT** (например до 5–8%) или увеличить **TAKE_PROFIT_PERCENT** (например до 10–12%), чтобы соотношение TP/SL было не хуже 1:1.
- Уменьшить **MAX_CONCURRENT** (например до 10–20), чтобы не размазывать капитал по десяткам сделок.
- При желании сузить список пар: **SCOPE = 'whitelist'** и задать **WHITELIST** только ликвидными парами (BTC, ETH, топ по объёму).

### 3.2. Посмотреть фактические сделки
Запустить разбор по данным с биржи:
```bash
python scripts/analyze_trades_rsi_exit.py --from-exchange --limit 200 --output report.txt
```
По отчёту будет видно, как часто выход по RSI совпадает с убытком и по каким парам хуже всего.

Расширенный отчёт (вход/выход RSI, причины закрытия):
```bash
python scripts/analyze_exchange_trades_full.py --db --output report_full.txt
```

### 3.3. Дальнейшие шаги по коду (по желанию)
- Добавить проверку суммарного риска/просадки перед открытием новой позиции.
- Включить или вернуть фильтр по минимальной ликвидности/объёму для отсева слабых пар.
- Пересмотреть пороги RSI выхода (65/60, 35/40) и логику «ждать безубыток» под свою статистику.

---

## 4. Итог

Основные драйверы плохого результата:
1. Невыгодное соотношение TP 5% / SL 15%.
2. Нет ограничения по суммарному риску — только по количеству ботов.
3. Вход/выход только по RSI без фильтра по ликвидности.

---

## 5. Внесённые изменения (по результатам анализа)

**sync_and_cache.py** — при обнаружении закрытия на бирже (CLOSED_ON_EXCHANGE) в `save_bot_trade_history` теперь сохраняются:
- `entry_rsi` — из `bot_data.last_rsi`
- `exit_rsi` — из `coins_rsi_data` на момент закрытия (по таймфрейму бота)

Это позволит скрипту `analyze_trades_rsi_exit.py` проверять соответствие выхода порогам RSI.

**configs/bot_config.py** — в BLACKLIST добавлены худшие монеты по отчёту:
- IOST, SPACE, ACX, BOBBOB, FHE, COOKIE (многократные убытки −0.1+ USDT)
