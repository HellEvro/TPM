# Сводка изменений: Защита bot_history.json от AI симуляций

## Измененные файлы:

### 1. `bot_engine/bot_history.py` - ОСНОВНОЙ ФАЙЛ
**Что изменилось:**
- Исправлена логика определения AI симуляций: `decision_source='AI'` больше НЕ означает автоматически `is_simulated=False`
- Улучшен метод `_is_simulated_entry()`: теперь проверяет `bot_id` на признаки симуляции
  - Реальные боты: короткий `bot_id` (символ монеты, например "BTC", "ETH")
  - AI симуляции: длинный `bot_id` с маркерами (например, "ai_simulation_...", "demo_bot_...")
- Обновлены все вызовы `_is_simulated_entry()`: теперь передается `bot_id` для точного определения
- Исправлена логика в `_load_history()`: для `decision_source='AI'` проверяются признаки симуляции
- Исправлена логика в `_add_history_entry()` и `_add_trade_entry()`: для `decision_source='AI'` проверяются признаки симуляции

**Результат:** AI симуляции больше не попадают в `bot_history.json` как реальные сделки

---

### 2. `scripts/rebuild_bot_history_from_exchange.py` - ЭКСТРЕННЫЙ СКРИПТ
**Что изменилось:**
- Скрипт теперь **НЕ перезаписывает** файл полностью
- **Сохраняет** все существующие сделки ботов (`decision_source='SCRIPT'` или `'AI'`)
- **Добавляет** только новые сделки с биржи (`decision_source='EXCHANGE_IMPORT'`)
- Обновлена документация: скрипт используется только в экстренных случаях для восстановления потерянных сделок

**Результат:** При запуске rebuild сохраняются сделки ботов, добавляются только сделки с биржи

---

### 3. `scripts/update_history_with_rsi.py`
**Что изменилось:**
- Исправлена логика для `decision_source='AI'`: теперь проверяются признаки симуляции по `bot_id`
- Для `decision_source='EXCHANGE_IMPORT'` и `'SCRIPT'` автоматически ставится `is_simulated=False`

**Результат:** Скрипт корректно определяет симуляции при обновлении RSI

---

### 4. `bots_modules/bot_class.py`
**Что изменилось:**
- Улучшено логирование открытия позиций: добавлены информационные сообщения
- Все вызовы `log_position_opened()` и `log_position_closed()` используют `is_simulated=False`
- Добавлены сообщения для диагностики: когда позиция логируется, когда пропускается

**Результат:** Лучшая диагностика записи позиций в `bot_history.json`

---

### 5. `bots_modules/sync_and_cache.py`
**Что изменилось:**
- Обновлен комментарий: уточнено, что логируются только сделки ботов, закрытые вручную на бирже
- Это НЕ ручные сделки трейдера, а закрытие позиций ботов вручную

**Результат:** Уточнено назначение логирования

---

### 6. Новые скрипты для диагностики:
- `scripts/check_bot_history_stats.py` - проверка статистики `bot_history.json`
- `scripts/compare_bot_history.py` - сравнение двух файлов `bot_history.json`
- `scripts/monitor_bot_history.py` - мониторинг изменений в реальном времени
- `scripts/analyze_bot_history_detailed.py` - детальный анализ файла

---

## ИТОГОВЫЙ РЕЗУЛЬТАТ:

✅ **`bot_history.json` содержит ТОЛЬКО сделки ботов из `bots.py`:**
   - Сделки, открытые по сигналам системы
   - Сделки, запущенные по кнопке в интерфейсе
   - Все с `is_simulated=False` и `decision_source='SCRIPT'` или `'AI'`

✅ **`ai.py` НЕ пишет в `bot_history.json`** - проверено, нет вызовов `log_position`

✅ **Скрипт `rebuild_bot_history_from_exchange.py`** - только для экстренного восстановления:
   - Сохраняет все сделки ботов
   - Добавляет только сделки с биржи для восстановления потерянных

✅ **AI симуляции определяются корректно** по `bot_id` и не попадают в `bot_history.json`

